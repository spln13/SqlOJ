# 关于题库和竞赛

## 题库

- 题库中包含若干基础习题。
- 题目中不包含测试样例
- 可由学生出题，老师与管理员对题目进行审核
- 题库系统设置排行榜，通过积分进行排名。机制如下:`easy: 3分; medium: 7分; hard: 15分`

## 竞赛

1. 作业和课堂练习统一采用竞赛的模式。
2. 初始化竞赛时需要指定参与的班级, 竞赛开始时间， 持续时间，以及包含的习题。
3. 包含的习题须由出题人从题库中选定，被选中的习题生成习题副本,提交记录全部指向此习题副本。
4. 竞赛开始时，被引用的题目无法被竞赛用户查看。
5. 竞赛设置竞赛排行榜，采用罚时机制。如: 一次未通过罚时1min，最后通过通过题数以及用时数排名。

### 创建竞赛

教师从题库中选择题目，设置开始时间、结束时间、竞赛名字、勾选参与的班级。
 
[//]: # (以下方案暂时不需要用)
[//]: # (关于参与竞赛用户无法查看竞赛引用题目功能由Redis实现。)

[//]: # ()
[//]: # (使用以竞赛ID为键值的Set数据结构，Set中包括参与竞赛的学生ID。)

[//]: # ()
[//]: # (设置该Set生效时间为竞赛开始时间，设置该Set过期时间为竞赛开始时间+竞赛持续时间。统一使用UTC。)

[//]: # (这种方式也可以实现控制用户对竞赛对权限。)

[//]: # ()
[//]: # (同理，在Redis中维护以题目ID为键值的Set数据结构, 其中存储引用该题目的竞赛, 该Set不设置过期时间。)

[//]: # ()
[//]: # (当用户从题库访问该题目时, 前往Redis中判断题目的Set中是否存在竞赛, 依次访问该竞赛查看其是否过期。)

[//]: # (1. 若过期, 从Set移除该元素)

[//]: # (2. 若未过期, 查看自己的ID是否在该竞赛禁止学生ID表中。)

[//]: # ()
[//]: # (关于权限判断: 权限判断在用户访问`/problem/123/`url后进行判断, 使用权限判断中间件。)

为了方便统计学生做题情况，排除学生之前对此题对提交记录，需要对题库中引用对题目生成副本题目。即在竞赛题库表中插入该题目，并设置单独的竞赛提交记录表。

为了方便统计在某次竞赛中完成题目情况，使用竞赛做题状态表，使用三个字段标识一条记录: `userID, contestID, exerciseID`;

暂时不用考虑竞赛进行时，参与竞赛的用户访问题库中相同题目。此情况只需要使用竞赛鉴权中间件即可。操作如下
> 1. 将参与竞赛的学生ID缓存在Redis中以竞赛ID为Key的Set中，设置过期时间为竞赛结束时间，通过新的key-value(kv1)设置竞赛开始时间，并且设置kv1过期时间为竞赛结束时间
> 2. 当某个用户发起访问竞赛请求(包括查看竞赛题单，竞赛页面，竞赛提交)时，首先查看kv1检查竞赛是否开始，若未开始则abort().
> 3. 若竞赛已经开始,则访问对应的Set中是否有自己的ID,若无则abort()，若有则next().

用户在竞赛中提交也应当使用竞赛鉴权中间件
> 1. 将参与竞赛的学生ID缓存在Redis中以竞赛ID为Key的Set中，设置过期时间为竞赛结束时间，通过新的key-value(kv1)设置竞赛开始时间，并且设置kv1过期时间为竞赛结束时间
> 2. 当某个用户发起访问竞赛请求时，首先查看kv1检查竞赛是否开始，若kv1不存在或者竞赛未开始则abort().
> 3. 若竞赛已经开始,则访问对应的Set中是否有自己的ID,若无则abort()，若有则next().